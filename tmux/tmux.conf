# ============================================================================
# キーバインディング基本設定
# ============================================================================
# プレフィックスキーをCtrl-Aに設定（Ctrl-Bはvimで使用）
set -g prefix C-a
unbind C-b
bind C-a send-prefix

# ============================================================================
# ウィンドウとペイン設定
# ============================================================================
# ウィンドウを0から番号付け
set -g base-index 1
setw -g pane-base-index 1

# ウィンドウ分割時に現在のディレクトリを保持
bind '%' split-window -h -c '#{pane_current_path}'
bind '"' split-window -v -c '#{pane_current_path}'
bind c new-window -c '#{pane_current_path}'

# ペイン移動をvimキー風に（Prefix+hjkl）
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R

# ペイン リサイズをvimキー風に
bind -r H resize-pane -L 5
bind -r J resize-pane -D 5
bind -r K resize-pane -U 5
bind -r L resize-pane -R 5

# ============================================================================
# vim-tmux連携（Smart pane switching with awareness of vim splits）
# ============================================================================
# vim-tmuxnavigatorプラグイン対応
is_vim="ps -o state= -o comm= -t '#{pane_tty}' | grep -iqE '^[^TXZ ]+ +(\\S+\\/)?g?(view|n?vim?x?)(diff)?$'"

bind-key -n C-h if-shell "$is_vim" 'send-keys C-h' 'select-pane -L'
bind-key -n C-j if-shell "$is_vim" 'send-keys C-j' 'select-pane -D'
bind-key -n C-k if-shell "$is_vim" 'send-keys C-k' 'select-pane -U'
bind-key -n C-l if-shell "$is_vim" 'send-keys C-l' 'select-pane -R'
bind-key -n C-\\ if-shell "$is_vim" 'send-keys C-\\' 'select-pane -l'

# ============================================================================
# キーボード設定
# ============================================================================
# マウスサポート
set -g mouse on

# xterm-256colorを使用
set -g default-terminal "tmux-256color"
set -ga terminal-overrides ",xterm-256color:RGB"

# ESCキーのレスポンスを改善（vim用）
set -s escape-time 0

# ============================================================================
# ステータスバー設定
# ============================================================================
set -g status-position bott

# Catppuccinテーマ設定
set -g @catppuccin_flavor "mocha"

# ステータスラインの背景を透明にする
set -g @catppuccin_status_background "none"

# 四角形のシンプルなUIに設定
set -g @catppuccin_window_status_style "basic"

# ウィンドウリストの表示設定
set -g @catppuccin_window_number_position "left"
set -g @catppuccin_window_text "  #(/Users/shin/.config/tmux/scripts/icon_mapper.sh #{pane_current_command})"
set -g @catppuccin_window_current_text "  #(/Users/shin/.config/tmux/scripts/icon_mapper.sh #{pane_current_command})"

# ステータスモジュール - シンプルに整理
set -g @catppuccin_status_modules_left ""
set -g @catppuccin_status_modules_right "date_time"

# ============================================================================
# ビジュアル設定
# ============================================================================
# ウィンドウ名が変更されたときに自動でリネーム
setw -g automatic-rename on
setw -g automatic-rename-format '#{pane_current_command}'

# アクティブなウィンドウをハイライト
# setw -g monitor-activity on
# set -g visual-activity off

set-option -g pane-border-status off
set-option -g pane-border-format ""  # 空にする

# ステータスバー左側のモジュールを空にする（[0]などの表示を消す）
set -g @catppuccin_status_modules_left ""
set -g status-left ""

# ステータスバー右側に表示するモジュール
# directory: カレントディレクトリ
# session: セッション名（プロジェクト管理に重要）
# date_time: 日時
set -g @catppuccin_status_modules_right "directory session date_time"
set -g @catppuccin_status_left_separator  " "
set -g @catppuccin_status_right_separator ""
set -g @catppuccin_status_right_separator_inverse "no"
set -g @catppuccin_status_fill "icon"
set -g @catppuccin_status_connect_separator "no"

# ディレクトリ表示のテキスト（現在のパスを表示）
set -g @catppuccin_directory_text "#{pane_current_path}"


#
# ============================================================================
# クリップボード連携
# ============================================================================
# macOS用のクリップボード連携
if-shell 'command -v reattach-to-user-namespace > /dev/null' \
  'bind -T copy-mode-vi y send-keys -X copy-pipe-and-cancel "reattach-to-user-namespace pbcopy"' \
  'bind -T copy-mode-vi y send-keys -X copy-pipe-and-cancel "pbcopy"'

# コピーモードをvi風に
setw -g mode-keys vi
bind-key -T copy-mode-vi v send-keys -X begin-selection
bind-key -T copy-mode-vi y send-keys -X copy-selection
bind-key -T copy-mode-vi r send-keys -X rectangle-toggle

# ============================================================================
# プラグイン設定
# ============================================================================
# Catppuccinプラグインの読み込み
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible' # 多くの理にかなったデフォルト設定

# テーマプラグイン
set -g @plugin 'catppuccin/tmux'

# ナビゲーションプラグイン (tmux-vim)
set -g @plugin 'christoomey/vim-tmux-navigator'

# セッション永続化プラグイン (tmux-stoer-settsion -> tmux-resurrect)
set -g @plugin 'tmux-plugins/tmux-resurrect'

# セッション自動保存・復元 (推奨追加)
set -g @plugin 'tmux-plugins/tmux-continuum'

# ------------------------------------------------------------------------------
# 6. プラグイン詳細設定 (Plugin Configurations)
# ------------------------------------------------------------------------------

# -- tmux-resurrect 設定 --
# Vim/Neovimのセッション復元を有効化
# (Vim側でSession.vimを保存している場合、自動で読み込む)
set -g @resurrect-strategy-vim 'session'
set -g @resurrect-strategy-nvim 'session'

# ペインの内容（スクロールバックバッファ）も保存・復元する
set -g @resurrect-capture-pane-contents 'on'

# -- tmux-continuum 設定 --
# Tmux起動時に、最後に保存された環境を自動的に復元する
set -g @continuum-restore 'on'
run ~/.config/tmux/plugins/catppuccin/tmux/catppuccin.tmux

run '~/.tmux/plugins/tpm/tpm'
